<!DOCTYPE html>

<html>
<head>
  <title>program.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>program.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> createUsage = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./usage'</span>)
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)
<span class="hljs-keyword">var</span> getopt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./getopt'</span>)
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
<span class="hljs-keyword">var</span> slice = [].slice
<span class="hljs-keyword">var</span> interrupt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'interrupt'</span>).createInterrupter(<span class="hljs-string">'bigeasy.arguable'</span>)
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">var</span> Command = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./command'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newListener</span> (<span class="hljs-params">eventName</span>) </span>{
    <span class="hljs-keyword">switch</span> (eventName) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'shutdown'</span>:
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._shutdown.count == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>._process.on(<span class="hljs-string">'SIGINT'</span>, <span class="hljs-keyword">this</span>._shutdown.listener)
            <span class="hljs-keyword">this</span>._process.on(<span class="hljs-string">'SIGTERM'</span>, <span class="hljs-keyword">this</span>._shutdown.listener)
        }
        <span class="hljs-keyword">this</span>._shutdown.count++
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">this</span>._getListenerProxy(eventName).count++
        <span class="hljs-keyword">break</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeListener</span> (<span class="hljs-params">eventName</span>) </span>{
    <span class="hljs-keyword">switch</span> (eventName) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'shutdown'</span>:
        <span class="hljs-keyword">this</span>._shutdown.count--
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._shutdown.count == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>._process.removeListener(<span class="hljs-string">'SIGINT'</span>, <span class="hljs-keyword">this</span>._shutdown.listener)
            <span class="hljs-keyword">this</span>._process.removeListener(<span class="hljs-string">'SIGTERM'</span>, <span class="hljs-keyword">this</span>._shutdown.listener)
        }
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">var</span> proxy = <span class="hljs-keyword">this</span>._getListenerProxy(eventName)
        proxy.count--
        <span class="hljs-keyword">if</span> (proxy.count == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>._process.removeListener(eventName, proxy.listener)
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._proxies[eventName]
        }
        <span class="hljs-keyword">break</span>
    }
}

</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This will never be pretty. Let it be ugly. Let it swallow all the sins before
they enter your program, so that your program can be a garden of pure
ideology.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Program</span> (<span class="hljs-params">usage, env, argv, io, module</span>) </span>{
    <span class="hljs-keyword">this</span>._usage = usage

</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>use environment <code>LANG</code> or else language of first usage definition</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.lang = env.LANG ? env.LANG.split(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>] : usage.language

    <span class="hljs-keyword">this</span>.path = []

    <span class="hljs-keyword">var</span> opt = getopt(usage.getPattern(), argv)
    <span class="hljs-keyword">if</span> (opt.abend) {
        <span class="hljs-keyword">this</span>.abend(opt.abend, opt.context)
    }
    <span class="hljs-keyword">this</span>.command = <span class="hljs-keyword">new</span> Command(<span class="hljs-keyword">this</span>, <span class="hljs-literal">null</span>, opt)
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.command) {
        <span class="hljs-keyword">this</span>.path = []
        <span class="hljs-keyword">this</span>.abend(<span class="hljs-string">'command required'</span>)
    }
    <span class="hljs-keyword">var</span> path = [], iterator = <span class="hljs-keyword">this</span>.command
    <span class="hljs-keyword">while</span> (iterator.command) {
        path.push(iterator.command.name)
        iterator = iterator.command
    }

    <span class="hljs-keyword">this</span>.argv = argv = argv.slice()
    <span class="hljs-keyword">this</span>.params = {}
    <span class="hljs-keyword">this</span>.env = env
    <span class="hljs-keyword">this</span>.stdout = io.stdout
    <span class="hljs-keyword">this</span>.stderr = io.stderr
    <span class="hljs-keyword">this</span>.stdin = io.stdin
    <span class="hljs-keyword">this</span>.params = io.params
    <span class="hljs-keyword">this</span>.send = io.send
    <span class="hljs-keyword">this</span>._require = io.require
    <span class="hljs-keyword">this</span>._process = io.events
    <span class="hljs-keyword">this</span>._hooked = {} <span class="hljs-comment">// TODO outgoing.</span>
    <span class="hljs-keyword">this</span>._module = <span class="hljs-built_in">module</span>

    <span class="hljs-keyword">this</span>.path = path

    events.EventEmitter.call(<span class="hljs-keyword">this</span>)

    <span class="hljs-keyword">this</span>._proxies = {}
    <span class="hljs-keyword">this</span>._shutdown = {
        count: <span class="hljs-number">0</span>,
        listener: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'shutdown'</span>) }.bind(<span class="hljs-keyword">this</span>)
    }

    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'removeListener'</span>, removeListener.bind(<span class="hljs-keyword">this</span>))
    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'newListener'</span>, newListener.bind(<span class="hljs-keyword">this</span>))
}
util.inherits(Program, events.EventEmitter)

Program.prototype._getListenerProxy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">eventName</span>) </span>{
    <span class="hljs-keyword">var</span> proxy = <span class="hljs-keyword">this</span>._proxies[eventName]
    <span class="hljs-keyword">if</span> (proxy == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">var</span> listener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.emit.apply(<span class="hljs-keyword">this</span>, [ eventName ].concat(slice.call(<span class="hljs-built_in">arguments</span>)))
        }.bind(<span class="hljs-keyword">this</span>)
        <span class="hljs-keyword">this</span>._process.addListener(eventName, listener)
        proxy = <span class="hljs-keyword">this</span>._proxies[eventName] = { listener: listener, count: <span class="hljs-number">0</span> }
    }
    <span class="hljs-keyword">return</span> proxy
}

Program.prototype.disconnect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._process.disconnect()
}

Program.prototype.disconnectIf = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.connected) {
        <span class="hljs-keyword">this</span>.disconnect()
    }
}

Program.prototype.__defineSetter__(<span class="hljs-string">'exitCode'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">exitCode</span>) </span>{
    <span class="hljs-keyword">this</span>._process.exitCode = exitCode
})

Program.prototype.__defineGetter__(<span class="hljs-string">'exitCode'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._process.exitCode
})

Program.prototype.__defineGetter__(<span class="hljs-string">'connected'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._process.connected
})

</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>format messages using strings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Program.prototype.format = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._usage.format(<span class="hljs-keyword">this</span>.lang, <span class="hljs-keyword">this</span>.path, key, slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>))
}

</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>abend helper stops execution and prints a message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Program.prototype.abend = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> vargs = slice.call(<span class="hljs-built_in">arguments</span>), key = vargs.shift(), code
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key == <span class="hljs-string">'number'</span>) {
        <span class="hljs-keyword">this</span>._code = key
        key = vargs.shift()
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._code = <span class="hljs-number">1</span>
    }
    <span class="hljs-keyword">var</span> message
    <span class="hljs-keyword">if</span> (key) {
        message = <span class="hljs-keyword">this</span>._usage.format(<span class="hljs-keyword">this</span>.lang, <span class="hljs-keyword">this</span>.path, key, vargs)
    }
    <span class="hljs-keyword">this</span>._redirect = <span class="hljs-string">'stderr'</span>
    <span class="hljs-keyword">throw</span> interrupt({
        name: <span class="hljs-string">'abend'</span>,
        context: {
            method: <span class="hljs-string">'abend'</span>,
            key: key,
            vargs: vargs,
            stderr: message,
            code: <span class="hljs-keyword">this</span>._code
        }
    })
}

</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>help helper prints stops execution and prints the help message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Program.prototype.help = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._code = <span class="hljs-number">0</span>
    <span class="hljs-keyword">throw</span> interrupt({
        name: <span class="hljs-string">'help'</span>,
        context: {
            method: <span class="hljs-string">'help'</span>,
            stdout: <span class="hljs-keyword">this</span>._usage.chooseUsage(<span class="hljs-keyword">this</span>.lang),
            code: <span class="hljs-keyword">this</span>._code
        }
    })
}

Program.prototype.assert = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">condition, message</span>) </span>{
    <span class="hljs-keyword">if</span> (!condition) <span class="hljs-keyword">this</span>.abend(message)
}

Program.prototype.require = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">moduleName</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._require(moduleName)
}

Program.prototype.helpIf = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">help</span>) </span>{
    <span class="hljs-keyword">if</span> (help) <span class="hljs-keyword">this</span>.help()
}

Program.prototype.delegate = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, format</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.argv.length == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.abend(<span class="hljs-string">'sub command missing'</span>)
    }
    <span class="hljs-keyword">var</span> argv = <span class="hljs-keyword">this</span>.argv.slice()
    <span class="hljs-keyword">var</span> command = argv.shift()
    <span class="hljs-keyword">var</span> pkg
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> format == <span class="hljs-string">'function'</span>) {
        pkg = format(command, <span class="hljs-keyword">this</span>)
    } <span class="hljs-keyword">else</span> {
        pkg = util.format(format, command)
    }
    <span class="hljs-keyword">var</span> arguable
    <span class="hljs-keyword">try</span> {
        arguable = <span class="hljs-keyword">this</span>._module.require(pkg)
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-keyword">if</span> (error.code == <span class="hljs-string">'MODULE_NOT_FOUND'</span>) {
            <span class="hljs-keyword">this</span>.abend(<span class="hljs-string">'sub command not found'</span>, command, pkg)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> error
        }
    }
    arguable(argv, {
        stdout: <span class="hljs-keyword">this</span>.stdout,
        env: <span class="hljs-keyword">this</span>.env,
        stdin: <span class="hljs-keyword">this</span>.stdin,
        stderr: <span class="hljs-keyword">this</span>.stderr,
</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>TODO Should be this, not _process, maybe rename <code>_parent</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        events: <span class="hljs-keyword">this</span>._process,
        send: <span class="hljs-keyword">this</span>.send
    }, <span class="hljs-keyword">async</span>())
})

</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>exit helper stops execution and exits with the given code, hmm…
TODO This ought to be testable, how do I test this?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Program.prototype.exit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">code</span>) </span>{
    <span class="hljs-keyword">throw</span> interrupt({ name: <span class="hljs-string">'exit'</span>, context: { code: code } })
}

<span class="hljs-built_in">module</span>.exports = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, source, env, argv, io, main, module</span>) </span>{
    assert(<span class="hljs-built_in">arguments</span>.length == <span class="hljs-number">7</span>)
</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>parse usage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> usage = createUsage(source)
    <span class="hljs-keyword">if</span> (!usage) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'no usage found'</span>)
    }

</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>run program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    main(<span class="hljs-keyword">new</span> Program(createUsage(source), env, argv, io, <span class="hljs-built_in">module</span>), <span class="hljs-keyword">async</span>())
})

</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
